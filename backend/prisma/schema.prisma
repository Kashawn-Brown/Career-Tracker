generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String

  // Profile fields
  location     String?
  currentCompany  String?
  currentRole  String?
  skills       String[] @default([])
  linkedInUrl  String?
  githubUrl    String?
  portfolioUrl String?

  // Job search preferences (AI foundation)
  jobSearchTitlesText    String?
  jobSearchLocationsText String?
  jobSearchKeywordsText  String?
  jobSearchSummary       String?
  jobSearchWorkMode      WorkMode @default(UNKNOWN)

  // MVP: one base resume per user
  baseResumeUrl String?

  connections    Connection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  emailVerifiedAt DateTime?

  jobApplications JobApplication[]
  documents       Document[]
  aiArtifacts     AiArtifact[]

  authSessions    AuthSession[]

  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  passwordHistory         PasswordHistory[]


  @@map("users")
}

model AuthSession {
  id               String   @id @default(cuid())
  userId           String

  // Store only hashes (never raw tokens)
  refreshTokenHash String   @unique
  csrfTokenHash    String

  expiresAt        DateTime
  revokedAt        DateTime?
  lastUsedAt       DateTime?
  createdAt        DateTime @default(now())

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("auth_sessions")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique

  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique

  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("password_history")
}



model JobApplication {
  id          String @id @default(cuid())
  userId      String
  company     String
  position    String
  status      ApplicationStatus @default(APPLIED)
  dateApplied DateTime?

  location    String?
  locationDetails   String?

  jobType JobType @default(UNKNOWN)
  jobTypeDetails String?

  workMode   WorkMode @default(UNKNOWN)
  workModeDetails String?
  
  salaryText String?
  isFavorite Boolean  @default(false)

  jobLink      String?
  description  String?
  notes        String?
  tagsText     String?

  fitScore     Int?

  connections    ApplicationConnection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  fitUpdatedAt DateTime?

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents Document[]
  aiArtifacts AiArtifact[]

  @@index([userId])
  @@index([status])
  @@map("job_applications")
}

enum ApplicationStatus {
  WISHLIST
  APPLIED
  INTERVIEW
  OFFER
  REJECTED
  WITHDRAWN
}

enum JobType {
  UNKNOWN
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
}

enum WorkMode {
  UNKNOWN
  REMOTE
  HYBRID
  ONSITE
}


model Document {
  id               Int          @id @default(autoincrement())
  userId           String
  jobApplicationId String?

  kind         DocumentKind
  storageKey   String
  originalName String
  mimeType     String
  size         Int?
  url          String? 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobApplication JobApplication? @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jobApplicationId])
  @@map("documents")
}

enum DocumentKind {
  BASE_RESUME
  RESUME
  COVER_LETTER
  OTHER
  CAREER_HISTORY
}


model Connection {
  id            String   @id @default(cuid())
  userId        String

  name          String
  company       String?
  title         String?
  email         String?
  linkedInUrl   String?
  notes         String?

  phone         String?       // Add a type for phone (assuming String; adjust as needed)
  relationship  String?       // (e.g., recruiter, referrer, colleague)
  location      String?
  status        Boolean?      // (active, inactive, etc.)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications  ApplicationConnection[]

  @@index([userId])
  @@map("connections")
}

model ApplicationConnection {
  jobApplicationId String
  connectionId     String
  createdAt        DateTime @default(now())

  jobApplication JobApplication @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)
  connection     Connection     @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@id([jobApplicationId, connectionId])
  @@index([connectionId])
  @@map("application_connections")
}

model AiArtifact {
  id               String @id @default(cuid())
  userId           String
  jobApplicationId String

  kind    String
  payload Json
  model   String

  sourceDocumentId Int?

  createdAt DateTime @default(now())

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobApplication JobApplication @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jobApplicationId])
  @@index([jobApplicationId, kind])
  @@map("ai_artifacts")
}
